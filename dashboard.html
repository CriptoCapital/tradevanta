<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TradeVanta — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f1720;--card:#0d1116;--muted:#9aa6b2;--accent:#00c2a8;--accent2:#ff8a4b;--strong:#e6eef3}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--strong);background:var(--bg)}
  .app{display:grid;grid-template-columns:260px 1fr;gap:18px;height:100vh;padding:18px}
  .sidebar{background:var(--card);padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:14px}
  .logo{width:40px;height:40;border-radius:8px;background:linear-gradient(135deg,var(--accent),#00ffd5);display:flex;align-items:center;justify-content:center;color:#022;font-weight:700}
  .nav a{display:block;padding:10px;border-radius:8px;color:var(--muted);text-decoration:none;margin-top:6px}
  .nav a.active{background:rgba(0,0,0,0.15);color:var(--strong)}
  header{display:flex;justify-content:space-between;align-items:center}
  .topbar{background:var(--card);padding:12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center}
  .main{display:grid;grid-template-columns:2fr 360px;gap:18px}
  .card{background:var(--card);padding:16px;border-radius:12px}
  #chart{width:100%;height:320px}
  .tiles{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .tile{padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);min-width:110px}
  .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  .btn-buy{background:var(--accent);color:#022}
  .btn-sell{background:var(--accent2);color:#2b1000}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .currency-select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--strong)}
  .order-row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="logo">TV</div>
        <div>
          <div style="font-weight:700">TradeVanta</div>
          <div class="small muted" id="userEmail">guest</div>
        </div>
      </div>

      <nav class="nav">
        <a href="#" class="active">Dashboard</a>
        <a href="#">Orders</a>
        <a href="#">Wallet</a>
        <a href="#" id="logoutBtn">Sign out</a>
      </nav>

      <div style="margin-top:auto" class="small muted">Connected to Supabase</div>
    </aside>

    <section style="display:flex;flex-direction:column;gap:12px">
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-weight:700">Portfolio</div>
          <div class="small muted">overview & balances</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <select id="currency" class="currency-select">
            <option value="usd">USD</option>
            <option value="eur">EUR</option>
            <option value="ngn">NGN</option>
            <option value="btc">BTC</option>
          </select>
          <div class="small muted">Balance: <strong id="balance">$0</strong></div>
        </div>
      </div>

      <div class="main">
        <div>
          <div class="card">
            <canvas id="chart"></canvas>
            <div class="tiles" id="tickers"></div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Orders</div>
              <div class="small muted">Quick market order</div>
            </div>

            <div style="height:12px"></div>

            <div class="order-row">
              <select id="pair" class="currency-select">
                <option value="bitcoin">BTC / USD</option>
                <option value="ethereum">ETH / USD</option>
                <option value="solana">SOL / USD</option>
                <option value="cardano">ADA / USD</option>
              </select>

              <input id="amount" placeholder="Amount" style="padding:10px;border-radius:8px;background:#071018;border:1px solid rgba(255,255,255,0.04);color:var(--strong)" />
              <button id="buy" class="btn btn-buy">Buy</button>
              <button id="sell" class="btn btn-sell">Sell</button>
            </div>
            <div id="orderMsg" class="small muted" style="margin-top:10px"></div>
          </div>
        </div>

        <aside>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small muted">Portfolio value</div>
                <div style="font-weight:700" id="portfolioVal">$0</div>
              </div>
              <div style="text-align:right">
                <div class="small muted">24h</div>
                <div style="color:var(--accent)">+2.7%</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div style="font-weight:700;margin-bottom:8px">Wallets</div>
            <div id="wallets"></div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div style="font-weight:700">Quick Stats</div>
            <div class="small muted" style="margin-top:8px">Real-time market snapshot</div>
            <div id="miniTickers" style="margin-top:12px"></div>
          </div>
        </aside>
      </div>

    </section>
  </div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
/* CONFIG - replace with your Supabase project details */
const SUPABASE_URL = 'https://kmjgyqqbqcxwpavwgnsu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imttamd5cXFicWN4d3BhdndnbnN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTIzNjMsImV4cCI6MjA3NDcyODM2M30.uHWMB_DeQn4nQ-MWcwEKVhnskA_K1AlGoAacmxVu3b0';
const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Utilities */
const fmt = (n, currency='usd') => {
  if(currency === 'btc') return Number(n).toFixed(8) + ' BTC';
  return new Intl.NumberFormat('en-US',{style:'currency',currency:currency==='usd'?'USD':currency==='eur'?'EUR':'NGN'}).format(Number(n));
}

/* Chart.js setup */
const ctx = document.getElementById('chart').getContext('2d');
let chart = new Chart(ctx, {
  type:'line',
  data:{labels:[],datasets:[{label:'Price',data:[],tension:0.2,borderWidth:2,pointRadius:0}]},
  options:{plugins:{legend:{display:false}},scales:{x:{display:true},y:{display:true}}}
});

/* App state */
let state = {
  currency: localStorage.getItem('tradevanta_currency') || 'usd',
  prices: {},  // coin -> price in USD
  wallets: [], // fetched from supabase
  user: null
};

/* DOM */
const currencySelect = document.getElementById('currency');
currencySelect.value = state.currency;
const balanceEl = document.getElementById('balance');
const portfolioValEl = document.getElementById('portfolioVal');
const walletsEl = document.getElementById('wallets');
const tickersEl = document.getElementById('tickers');
const miniTickersEl = document.getElementById('miniTickers');
const userEmail = document.getElementById('userEmail');

/* Logout */
document.getElementById('logoutBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  await supabase.auth.signOut();
  localStorage.removeItem('tradevanta_demo');
  window.location.href = 'auth.html';
});

/* Demo session: if demo flag present, treat as guest */
function isDemo(){
  return !!localStorage.getItem('tradevanta_demo');
}

/* Initialize: check auth, then load data */
(async function init(){
  // Check Supabase session
  const { data } = await supabase.auth.getSession();
  if(data?.session){
    state.user = data.session.user;
    userEmail.textContent = state.user.email || state.user.user_metadata?.email || 'user';
    // fetch wallets
    await loadWallets();
  } else if(isDemo()){
    userEmail.textContent = 'demo';
    // create mock wallets
    state.wallets = [
      {currency:'usd',balance:12548.32},
      {currency:'btc',balance:0.2345}
    ];
    renderWallets();
  } else {
    // not authenticated — redirect to auth for real flows
    // but we allow viewing demo data if user wants
    userEmail.textContent = 'guest';
  }

  // Initial fetch of prices
  await fetchPrices(['bitcoin','ethereum','solana','cardano']);
  renderTickers();
  updatePortfolio();
  // load chart historical data
  await loadChartData('bitcoin');

  // periodic updates
  setInterval(async ()=>{
    await fetchPrices(['bitcoin','ethereum','solana','cardano']);
    renderTickers();
    updatePortfolio();
  }, 10000);
})();

/* Load wallets from Supabase */
async function loadWallets(){
  try {
    const { data, error } = await supabase.from('wallets').select('*').eq('user_id', state.user?.id);
    if(error) throw error;
    state.wallets = data || [];
    renderWallets();
  } catch(e){
    console.error('wallets load', e);
  }
}

/* Render wallets */
function renderWallets(){
  walletsEl.innerHTML = '';
  let totalUSD = 0;
  state.wallets.forEach(w=>{
    // convert using prices if available
    const cur = w.currency.toLowerCase();
    let valueUsd = Number(w.balance);
    // if it's crypto key we might have map; this is a simple demo
    if(cur === 'btc' && state.prices.bitcoin) valueUsd = Number(w.balance) * state.prices.bitcoin;
    if(cur === 'eth' && state.prices.ethereum) valueUsd = Number(w.balance) * state.prices.ethereum;
    totalUSD += valueUsd;
    const display = state.currency === 'btc' ? (valueUsd / state.prices.bitcoin || 0).toFixed(6) + ' BTC' : fmt(convertUSD(valueUsd, state.currency), state.currency === 'usd' ? 'usd' : state.currency);
    const el = document.createElement('div');
    el.style.display='flex';el.style.justifyContent='space-between';el.style.marginBottom='8px';
    el.innerHTML = `<div style="font-weight:700">${w.currency.toUpperCase()}</div><div class="muted">${display}</div>`;
    walletsEl.appendChild(el);
  });

  balanceEl.textContent = fmt(convertUSD(totalUSD, state.currency), state.currency);
  portfolioValEl.textContent = fmt(convertUSD(totalUSD, state.currency), state.currency);
}

/* Price fetching from CoinGecko */
async function fetchPrices(ids){
  try {
    const q = ids.join(',');
    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${q}&vs_currencies=usd`);
    const data = await res.json();
    // store USD prices
    ids.forEach(id => {
      state.prices[id] = data[id]?.usd || state.prices[id] || 0;
    });
  } catch(e){
    console.warn('price fetch failed', e);
  }
}

/* Render mini tickers */
function renderTickers(){
  tickersEl.innerHTML = '';
  miniTickersEl.innerHTML = '';
  const map = {
    bitcoin:'BTC',
    ethereum:'ETH',
    solana:'SOL',
    cardano:'ADA'
  };
  Object.keys(map).forEach(k=>{
    const priceUsd = state.prices[k] || 0;
    const display = state.currency === 'btc' ? (priceUsd / state.prices.bitcoin || 0).toFixed(6) + ' BTC' : fmt(convertUSD(priceUsd, state.currency), state.currency);
    const tile = document.createElement('div');
    tile.className='tile';
    tile.innerHTML = `<div style="font-size:12px;color:var(--muted)">${map[k]}</div><div style="font-weight:700">${display}</div>`;
    tickersEl.appendChild(tile);

    const mini = document.createElement('div');
    mini.style.display='flex';mini.style.justifyContent='space-between';mini.style.marginBottom='8px';
    mini.innerHTML= `<div>${map[k]}</div><div style="font-weight:700">${display}</div>`;
    miniTickersEl.appendChild(mini);
  });
}

/* Chart data: fetch CoinGecko market chart for a coin and plot */
async function loadChartData(coin='bitcoin'){
  try {
    const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=usd&days=7&interval=hourly`);
    const d = await res.json();
    const labels = d.prices.map(p=> new Date(p[0]).toLocaleString());
    const data = d.prices.map(p=> p[1]);
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  } catch(e){
    console.warn('chart load error',e);
  }
}

/* Orders (mock) */
document.getElementById('buy').addEventListener('click', ()=>placeOrder('buy'));
document.getElementById('sell').addEventListener('click', ()=>placeOrder('sell'));
async function placeOrder(type){
  const pair = document.getElementById('pair').value;
  const amount = Number(document.getElementById('amount').value || 0);
  const orderMsg = document.getElementById('orderMsg');
  if(!amount || amount <= 0){ orderMsg.textContent = 'Enter an amount'; return; }
  // This demo will store a transaction record in Supabase if authenticated
  if(state.user){
    const payload = {
      user_id: state.user.id,
      type: 'trade',
      currency: pair,
      amount: amount,
      meta: {side:type}
    };
    const { data, error } = await supabase.from('transactions').insert(payload);
    if(error){ orderMsg.textContent = 'Order failed: '+error.message; return; }
    orderMsg.textContent = `Order placed: ${type.toUpperCase()} ${amount} ${pair}`;
    // update wallets (in demo we won't update balances automatically)
    await loadWallets();
  } else {
    // demo — just show message
    orderMsg.textContent = `Demo order: ${type.toUpperCase()} ${amount} ${pair}`;
  }
}

/* Currency conversion helper (simple rates) */
async function getFxRates(){
  // Basic rates via free currency API or static fallback. For production use a reliable FX provider.
  // We'll fetch EUR and NGN from exchangerate.host
  try {
    const r = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=EUR,NGN');
    const data = await r.json();
    return {
      eur: data.rates.EUR || 0.9,
      ngn: data.rates.NGN || 1000
    };
  } catch(e){
    return { eur:0.9, ngn:1000 };
  }
}

async function convertUSD(valueUsd, target){
  if(target === 'usd') return valueUsd;
  if(target === 'btc'){
    // convert USD to BTC using current bitcoin price
    const btcPrice = state.prices.bitcoin || 1;
    return valueUsd / btcPrice;
  }
  const fx = await getFxRates();
  if(target === 'eur') return valueUsd * fx.eur;
  if(target === 'ngn') return valueUsd * fx.ngn;
  return valueUsd;
}

/* Helper wrapper that caches rates quick */
function convertUSD(valueUsd, target){
  if(target === 'usd') return valueUsd;
  if(target === 'btc'){
    const btcPrice = state.prices.bitcoin || 1;
    return valueUsd / btcPrice;
  }
  // synchronous fallback approximations
  const approx = { eur:0.92, ngn:1500 };
  return valueUsd * (approx[target] || 1);
}

/* Currency selector change */
currencySelect.addEventListener('change', async (e)=>{
  state.currency = e.target.value;
  localStorage.setItem('tradevanta_currency', state.currency);
  renderTickers();
  updatePortfolio();
  renderWallets();
});

/* Update portfolio (simple) */
function updatePortfolio(){
  // Recalculate portfolio shown value
  // For demo: we will sum wallets if any; otherwise use mock
  let totalUSD = 0;
  if(state.wallets && state.wallets.length){
    state.wallets.forEach(w=>{
      const c = w.currency.toLowerCase();
      let usdVal = Number(w.balance);
      if(c === 'btc' && state.prices.bitcoin) usdVal = Number(w.balance) * state.prices.bitcoin;
      if(c === 'usd') usdVal = Number(w.balance);
      totalUSD += usdVal;
    });
  } else {
    totalUSD = 12548.32;
  }

  const display = state.currency === 'btc' ? (totalUSD / (state.prices.bitcoin || 1)).toFixed(6) + ' BTC' : fmt(convertUSD(totalUSD, state.currency), state.currency);
  portfolioValEl.textContent = display;
}

/* minimal UX: clicking on a ticker will load chart for that coin */
document.getElementById('tickers').addEventListener('click', (e)=>{
  const tile = e.target.closest('.tile');
  if(!tile) return;
  // find coin by index
  const text = tile.innerText || '';
  if(text.includes('BTC')) loadChartData('bitcoin');
  if(text.includes('ETH')) loadChartData('ethereum');
  if(text.includes('SOL')) loadChartData('solana');
  if(text.includes('ADA')) loadChartData('cardano');
});
</script>
</body>
</html>
